
<!-- Cette page est basé sur la page utilisé par le list filter -->

<script src="../../../static/pagination.js" defer></script>

<!-- CDN de Jquery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script src="https://pagination.js.org/dist/2.6.0/pagination.min.js"></script>

<style>

.btn-list-filter-pagination-nav {
	list-style-type: none;
	width: 2em;
	height: 2em;
  border-width: 1px;
  border-color: rgb(172, 172, 172);
  border-style: solid;
  display: flex;
  justify-content: center
}

.out-of-pagination {
	display: none !important;
}

#pagination-container ul {
  display: flex;
}

.filtered-element {
  display: none !important;
}

</style>

{% load i18n %}
<link rel="stylesheet" type="text/css" href="../../../static/css/utils.css">

<details data-filter-title="{{ title }}" open>
  <summary>
    {% blocktranslate with filter_title=title %} By {{ filter_title }} {% endblocktranslate %}
  </summary>
  <input id="search-bar-input" type="text" placeholder="Entrez le nom du livre ici...">
  <div id="listfilter-container">
    <table id="books-list">
      <!-- Modification de la <ul> en <table> pour mieux utiliser Jquery-->
      {% for choice in choices %}
        <tr {% if choice.selected %} class="selected"{% endif %}>
        <td class="list-value"> <a href="{{ choice.query_string|iriencode }}">{{ choice.display }}</a></td></tr>
      {% endfor %}
      </table>
  </div>

  <!-- Conteneur de pagination, ici on l'ajoute sous la table -->
  <div id="pagination-container"></div>   

</details>

<!-- function simpleTemplating(data) {
  var html = '<table>';
  $.each(data, function(index, elt) {
    html += `<tr>${elt}</tr>`;
  });
  html += "</table>";
  return html;
} -->

<script>
  $(document).ready(function(){ // Attend que le DOM soit prêt pour charger le contenu
  
    var ELEMENT_PER_PAGE = 20;
    var PAGINATION_BASE_ID = "pagination-btn";

    var listData = []; // Contient toutes les données de la liste

    var currentPage = 1; // Par défaut //FIXME fonctionne quand on m'initialise 

    /**
     * Récupère toutes les données filtrées  
     */
    function getListData() {

      listData = [];
      $(".list-value").each(function() {
        if (!$(this).hasClass("filtered-element")) {
          listData.push($(this).prop('outerHTML'))

        }
      })  
      return listData;
    }

    function getNumberOfPages() {
      getListData()
      return Math.ceil(listData.length / ELEMENT_PER_PAGE);
    }

    /**
     * Actualise les données affichées dans la pagination
     */
    function showMatchingPage(numberOfPage, btnBaseId) {

      // On récupère les données associées à la page
      toShowData = getListData().splice(ELEMENT_PER_PAGE * (currentPage - 1), 
                                        ELEMENT_PER_PAGE);

      // Affiche / Cache les données en fonction de la page courante
      $(".list-value").each(function() {
        if (jQuery.inArray($(this).prop('outerHTML'), toShowData) > -1) {   
          $(this).removeClass("out-of-pagination");
        } else {
          $(this).addClass("out-of-pagination");
        }
      })

      // Affiche la barre de pagination
      $("#pagination-container").html(getPaginationNav(currentPage, numberOfPage, btnBaseId));

      // S'assure de ne pas avoir des duplications de données
      toShowData = []
    }

    /**
     * Gère la pagination du widget list-filter
     */
    function bindPaginationButtons(btnBaseId) {
        
      if (getListData().length > 0) {

        // On bind les boutons de navigation gauche et droite

        // On s'assure de ne pas binder plusieurs fois l'item
        $(document).off("click", `#${btnBaseId}-prev`)
        $(document).on("click" ,`#${btnBaseId}-prev` ,function() {
          if (currentPage > 1) {
            currentPage--;
            showMatchingPage(getNumberOfPages(), btnBaseId)
          }
        })
        
        // On s'assure de ne pas binder plusieurs fois l'item
        $(document).off("click", `#${btnBaseId}-next`)
        $(document).on("click" ,`#${btnBaseId}-next` ,function() {
          if (currentPage < getNumberOfPages()) {
            currentPage++;
            showMatchingPage(getNumberOfPages(), btnBaseId)          
          }
        })

        // On bind les boutons numérotés
        $(".bindable-nav-btn").each(function() {
          button = $(this)
          $(document).on("click", button, function() {
            console.log(button.text())
          })
        })


      } else {
        console.error('Aucune donnée à afficher pour la pagination.');
      }
    }

    // On initialise la pagination
    $("#pagination-container").html(getPaginationNav(currentPage, getNumberOfPages(), PAGINATION_BASE_ID));
    showMatchingPage(getNumberOfPages(), PAGINATION_BASE_ID)    
    bindPaginationButtons(PAGINATION_BASE_ID)

    // Dès que l'utilisateur lâche une touche sur la zone de saisi (keyup)
    $("#search-bar-input").on("keyup", function() { 
      // Ici, $(this) représente la barre de recherche de la liste
      
      var value = $(this).val().toLowerCase(); // Valeur de la barre de recherche
      $(".list-value").each(function() { // Permet d'itérer dans la table des éléments de liste (List Filter)
        // Ici, $(this) représente un élément de la liste (filter fait comme un parcours de liste)
        
        if ($(this).text() // Récupère le nom de la donnée affichée parcouru dans la liste
                   .toLowerCase() // La met en lowercase
                   .indexOf(value) > -1) {
            
            $(this).removeClass("filtered-element");
        } else {
            $(this).addClass("filtered-element");

        }
        // -- EXPLICATION DU indexOf() --
        // "a".indexOf("b") => -1 car "a" ne contient pas "b" mais
        // "fabrice".indexOf("b") => 2 car la 1ere occurrence de "b" est en indice 2
        
      });
      currentPage = 1;
      // $(this) change car pour chaque cas, on associe à this 
      // "l'élément" modifiable de la fonction anonyme

      bindPaginationButtons(PAGINATION_BASE_ID)
      showMatchingPage(getNumberOfPages(), PAGINATION_BASE_ID)
    });

    function getPaginationNav(actualPage, numberOfPage, btnBaseId) {
      
      let navBar = "<ul>";

      navBar += `<li id="${btnBaseId}-prev" class="btn-list-filter-pagination-nav">‹</li>`;

      // Cas où la pagination gère beaucoup de données
      if (actualPage - 5 > 3) {
        for (let pageNumber = 1; pageNumber < 3; pageNumber++) {
          if (pageNumber >= 1 && pageNumber <= numberOfPage) {
            navBar += `<li id="${btnBaseId}-${pageNumber}" class="btn-list-filter-pagination-nav bindable-nav-btn">${pageNumber}</li>`;
          }
        }
        navBar += `<li class="btn-list-filter-pagination-nav">...</li>`;
      }

      for (let pageNumber = actualPage - 1; pageNumber <= actualPage + 1; pageNumber++) {
        if (pageNumber >= 1 && pageNumber <= numberOfPage) {
        navBar += `<li id="${btnBaseId}-${pageNumber}" class="btn-list-filter-pagination-nav bindable-nav-btn`;
        navBar += pageNumber == actualPage ? " active-pagination-page" : "";
        navBar += `">${pageNumber}</li>`
        }
      }

      if (actualPage + 5 < numberOfPage) {
        navBar += `<li class="btn-list-filter-pagination-nav">...</li>`;
        for (let pageNumber = Math.ceil(numberOfPage) - 1; pageNumber <= numberOfPage; pageNumber++) {
          if (pageNumber >= 1 && pageNumber <= numberOfPage) {
            navBar += `<li id="${btnBaseId}-${pageNumber}" class="btn-list-filter-pagination-nav bindable-nav-btn">${pageNumber}</li>`;
          }
        }
      }

      navBar += `<li id="${btnBaseId}-next" class="btn-list-filter-pagination-nav">›</li>`;

      navBar += "</ul>";

      return navBar;
    }
  });
</script>