
<!-- Cette page est basé sur la page utilisé par le list filter -->

<script src="../../../static/pagination.js" defer></script>

<!-- CDN de Jquery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script src="https://pagination.js.org/dist/2.6.0/pagination.min.js"></script>

<style>

.btn-list-filter-pagination-nav {
	list-style-type: none;
	width: 2em;
	height: 2em;
  border-width: 1px;
  border-color: rgb(172, 172, 172);
  border-style: solid;
  display: flex;
  justify-content: center

}

.btn-list-filter-pagination-nav:hover {
  cursor: pointer;
}

.out-of-pagination {
	display: none !important;
}

#pagination-container ul {
  display: flex;
}

.filtered-element {
  display: none !important;
}

.active-pagination-page {
  background-color: #79aec8;
  color: azure;
}

#pagination-container {
  width: 25em;
}

.disabled-pagination-btn {
  background-color: rgb(224, 224, 224);
  color: rgb(187, 187, 187);
  cursor: not-allowed !important;
}

#pagination-navbar {
  display: flex;
  justify-content: space-between;
}

</style>

{% load i18n %}
<link rel="stylesheet" type="text/css" href="../../../static/css/utils.css">

<details data-filter-title="{{ title }}" open>
  <summary>
    {% blocktranslate with filter_title=title %} By {{ filter_title }} {% endblocktranslate %}
  </summary>
  <input id="search-bar-input" type="text" placeholder="Nom de la ressource">
  <div id="listfilter-container">
    <table id="books-list">
      <!-- Modification de la <ul> en <table> pour mieux utiliser Jquery-->
      {% for choice in choices %}
        <tr {% if choice.selected %} class="selected"{% endif %}>
        <td class="list-value"> <a href="{{ choice.query_string|iriencode }}">{{ choice.display }}</a></td></tr>
      {% endfor %}
      </table>
  </div>

  <!-- Conteneur de pagination, ici on l'ajoute sous la table -->
  <div id="pagination-container"></div>   
  <label for="goToPageInput">Aller à la page :</label>
  <input type="number" placeholder="1" id="paginator-page-selector">
</details>

<!-- function simpleTemplating(data) {
  var html = '<table>';
  $.each(data, function(index, elt) {
    html += `<tr>${elt}</tr>`;
  });
  html += "</table>";
  return html;
} -->

<script>
  $(document).ready(function(){ // Attend que le DOM soit prêt pour charger le contenu
  
    var ELEMENT_PER_PAGE = 20;
    var PAGINATION_BASE_ID = "pagination-btn";

    var listData = []; // Contient toutes les données de la liste

    var currentPage = 1; // Par défaut //FIXME fonctionne quand on m'initialise 

    /**
     * Récupère toutes les données filtrées  
     */
    function getListData() {

      listData = [];
      $(".list-value").each(function() {
        if (!$(this).hasClass("filtered-element")) {
          listData.push($(this).prop('outerHTML'))

        }
      })  
      return listData;
    }

    function getNumberOfPages() {
      getListData()
      return Math.ceil(listData.length / ELEMENT_PER_PAGE);
    }

    /**
     * Actualise les données affichées dans la pagination
     */
    function showMatchingPage() {

      // On récupère les données associées à la page
      toShowData = getListData().splice(ELEMENT_PER_PAGE * (currentPage - 1), 
                                        ELEMENT_PER_PAGE);

      // Affiche / Cache les données en fonction de la page courante
      $(".list-value").each(function() {
        if (jQuery.inArray($(this).prop('outerHTML'), toShowData) > -1) {   
          $(this).removeClass("out-of-pagination");
        } else {
          $(this).addClass("out-of-pagination");
        }
      })

      // Affiche la barre de pagination
      
      $("#pagination-container").html(getPaginationNav(currentPage, PAGINATION_BASE_ID));
      bindPaginationButtons(PAGINATION_BASE_ID)

      // S'assure de ne pas avoir des duplications de données
      toShowData = []
    }

    /**
     * Gère la saisi d'une page spécifique
     */
    function goToPage(givenPage) {
      if (givenPage >= 1 && givenPage <= getNumberOfPages()) {
        // Affiche la barre de pagination
        $("#pagination-container").html(getPaginationNav(givenPage, getNumberOfPages()));
        showMatchingPage()    
        bindPaginationButtons()
      }
    }

    /**
     * Gère la pagination du widget list-filter
     */
    function bindPaginationButtons() {
        
      if (getListData().length > 0) {

        // On bind les boutons de navigation gauche et droite

        // On s'assure de ne pas binder plusieurs fois l'item
        $(document).off("click", `#${PAGINATION_BASE_ID}-prev`)
        if (currentPage > 1) {
          $(document).on("click" ,`#${PAGINATION_BASE_ID}-prev` ,function() {
              currentPage--;
              showMatchingPage()
          })
        } else {
          $(`#${PAGINATION_BASE_ID}-prev`).addClass("disabled-pagination-btn");
        }
        
        // On s'assure de ne pas binder plusieurs fois l'item
        $(document).off("click", `#${PAGINATION_BASE_ID}-next`)
        if (currentPage < getNumberOfPages()) {
          $(document).on("click" ,`#${PAGINATION_BASE_ID}-next` ,function() {
            currentPage++;
            showMatchingPage()          
          })
        } else {
          $(`#${PAGINATION_BASE_ID}-next`).addClass("disabled-pagination-btn");
        }

        // On bind les boutons numérotés
        $(".bindable-nav-btn").each(function() {
          $(this).off("click"); // Pour ne pas doubler les binds
          $(this).on("click", function() {
            // Redirige vers la page du numéro
            currentPage = parseInt($(this).text())
            showMatchingPage()          

          });

        })
      } else {
        console.error('Aucune donnée à afficher pour la pagination.');
      }
    }

    // On initialise la pagination
    goToPage(currentPage)

    // Dès que l'utilisateur lâche une touche sur la zone de saisi (keyup)
    $("#search-bar-input").on("keyup", function() { 
      // Ici, $(this) représente la barre de recherche de la liste
      
      var value = $(this).val().toLowerCase(); // Valeur de la barre de recherche
      $(".list-value").each(function() { // Permet d'itérer dans la table des éléments de liste (List Filter)
        // Ici, $(this) représente un élément de la liste (filter fait comme un parcours de liste)
        
        if ($(this).text() // Récupère le nom de la donnée affichée parcouru dans la liste
                   .toLowerCase() // La met en lowercase
                   .indexOf(value) > -1) {
            
            $(this).removeClass("filtered-element");
        } else {
            $(this).addClass("filtered-element");

        }
        // -- EXPLICATION DU indexOf() --
        // "a".indexOf("b") => -1 car "a" ne contient pas "b" mais
        // "fabrice".indexOf("b") => 2 car la 1ere occurrence de "b" est en indice 2
        
      });
      currentPage = 1;
      // $(this) change car pour chaque cas, on associe à this 
      // "l'élément" modifiable de la fonction anonyme

      showMatchingPage();
    });

    $("#paginator-page-selector").on("keyup", function() {
      selectedPage = $(this).val();
      if (selectedPage.length == 0) {
        // Plus rien n'est saisi dans la barre de recherche 
        currentPage = 1
        goToPage(currentPage);
      
      } else if (jQuery.type(parseInt(selectedPage)) === "number") {
        // On change de page si la donnée est un nombre
        
        // Si on donne un trop grand nombre, on obtient la dernière page
        currentPage = parseInt(selectedPage) > getNumberOfPages() ? getNumberOfPages() : parseInt(selectedPage);
        goToPage(currentPage);
      } 
      

    })

    function getPaginationNav(actualPage) {
      
      // Le conteneteditable empêche tout le texte d'être sélectionné
      let navBar = "<ul id='pagination-navbar' conteneteditable='false'>";

      // Bouton pour aller sur la page précédente
      navBar += `<li id="${PAGINATION_BASE_ID}-prev" class="btn-list-filter-pagination-nav">‹</li>`;

      if (getNumberOfPages() > 8) {
        // Cas où la pagination gère beaucoup de données
        
        // Permet d'afficher les pages qui débutent la pagination
        if (actualPage - 8 > 0) {
          for (let pageNumber = 1; pageNumber < 3; pageNumber++) {
            if (pageNumber >= 1 && pageNumber <= getNumberOfPages()) {
              navBar += `<li id="${PAGINATION_BASE_ID}-${pageNumber}" class="btn-list-filter-pagination-nav bindable-nav-btn">${pageNumber}</li>`;
            }
          }
          navBar += `<li class="elt-list-filter-pagination-nav">...</li>`;
        }

        // TODO : Supprimer pages adjacentes à la page courante + POO + augmenter nb pages aux extrémités

        // Permet d'afficher les pages autour de la page courante
        for (let pageNumber = actualPage - 1; pageNumber <= actualPage + 1; pageNumber++) {
          if (pageNumber >= 1 && pageNumber <= getNumberOfPages()) {
          navBar += `<li id="${PAGINATION_BASE_ID}-${pageNumber}" class="btn-list-filter-pagination-nav bindable-nav-btn`;
          navBar += pageNumber == actualPage ? " active-pagination-page" : "";
          navBar += `">${pageNumber}</li>`
          }
        }

        // Permet d'afficher les pages qui terminent la pagination
        if (actualPage + 5 < getNumberOfPages()) {
          navBar += `<li class="elt-list-filter-pagination-nav">...</li>`;
          for (let pageNumber = Math.ceil(getNumberOfPages()) - 1; pageNumber <= getNumberOfPages(); pageNumber++) {
            if (pageNumber >= 1 && pageNumber <= getNumberOfPages()) {
              navBar += `<li id="${PAGINATION_BASE_ID}-${pageNumber}" class="btn-list-filter-pagination-nav bindable-nav-btn">${pageNumber}</li>`;
            }
          }
        }
      } else {
        for (let pageNumber = 1; pageNumber <= getNumberOfPages(); pageNumber++) {
          navBar += `<li id="${PAGINATION_BASE_ID}-${pageNumber}" class="btn-list-filter-pagination-nav bindable-nav-btn`;
          navBar += pageNumber == actualPage ? " active-pagination-page" : "";
          navBar += `">${pageNumber}</li>`
        } 
      }

      // Bouton pour aller sur la page suivante
      navBar += `<li id="${PAGINATION_BASE_ID}-next" class="btn-list-filter-pagination-nav">›</li>`;

      navBar += "</ul>";

      return navBar;
    }
  });
</script>